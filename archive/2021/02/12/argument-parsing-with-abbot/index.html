<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="twitter:card" content="summary">
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Argument parsing with Abbot" />
  <meta name="twitter:description" content="Abbot has some neat built-in tools for argument parsing that make use of C# tuple deconstruction for fun and profit." />
  <meta name="twitter:url" content="" />
  <meta name="twitter:image" content="https://user-images.githubusercontent.com/19977/107692389-92799080-6c61-11eb-9710-c75811b528ee.jpg" /><meta name="twitter:site" content="@haacked" />

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Argument parsing with Abbot | You’ve Been Haacked</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Argument parsing with Abbot" />
<meta name="author" content="Phil Haack" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Abbot has some neat built-in tools for argument parsing that make use of C# tuple deconstruction for fun and profit." />
<meta property="og:description" content="Abbot has some neat built-in tools for argument parsing that make use of C# tuple deconstruction for fun and profit." />
<meta property="og:site_name" content="You’ve Been Haacked" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-12T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Argument parsing with Abbot" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Phil Haack"},"@type":"BlogPosting","description":"Abbot has some neat built-in tools for argument parsing that make use of C# tuple deconstruction for fun and profit.","url":"/archive/2021/02/12/argument-parsing-with-abbot/","headline":"Argument parsing with Abbot","dateModified":"2021-02-12T00:00:00-06:00","datePublished":"2021-02-12T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"/archive/2021/02/12/argument-parsing-with-abbot/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/css/main.css">
  <link type="application/atom+xml" rel="alternate" href="/atom.xml" title="You've Been Haacked" />
  
  <script src="/assets/js/utils.js"></script>
  <script src="/assets/js/slash.js" async></script>
  
	<script src="/assets/js/md5.min.js" async></script>
  <script src="/assets/js/comment-box.js" async></script>
  
  <link href="https://fonts.googleapis.com/css?family=Mate|Open+Sans|Open+Sans+Condensed:300" rel="stylesheet">
</head>

  <body>
    <header class="header" class="inner"><div class="site-header">
  <div class="profilepic">
    
    <img src="https://2.gravatar.com/avatar/cdf546b601bf29a7eb4ca777544d11cd?s=160" alt="Profile Picture" />
    
  </div>

  
  <a class="site-title" rel="author" href="/">You&#39;ve Been Haacked</a>
  
  <div class="site-subtitle">…and you like it</div>
  
  
  
    <nav class="site-nav">
      <ul>
          
          
          
          
          <li><a class="page-link" href="/about/">About</a></li>
          
        
          
          
          
          <li><a class="page-link" href="/archives/">Archives</a></li>
          
        
          
          
          
          <li><a class="page-link" href="/contributors/">Contributors</a></li>
          
        
        
        <li><a class="page-link" href="https://github.com/Haacked/feedback/issues/new">Contact</a></li>
        
      </ul>
    </nav>
  
  <div class="social-footer">
    <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/haacked"><svg class="svg-icon"><use xlink:href="/assets/svg/minima-social-icons.svg#github"></use></svg> <span class="username">haacked</span></a></li>
  
  
  
  <li><a href="https://twitter.com/haacked"><svg class="svg-icon"><use xlink:href="/assets/svg/minima-social-icons.svg#twitter"></use></svg> <span class="username">haacked</span></a></li>
  
  
  <li><a href="http://feeds.haacked.com/haacked"><svg class="svg-icon"><use xlink:href="/assets/svg/minima-social-icons.svg#rss"></use></svg> <span>rss</span></a></li>
</ul>


<!--  viewBox="0 1 16 14" -->
  </div>
</div>
</header>
    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Argument parsing with Abbot</h1>
    <div class="meta">
  <time class="date dt-published" datetime="2021-02-12T00:00:00-06:00" itemprop="datePublished">
    
    Feb 12, 2021
  </time>
  <span class="tags">

  <a href="/tags/#abbot">abbot</a> 

  <a href="/tags/#chatops">chatops</a> 

  <a href="/tags/#csharp">csharp</a> 

</span>
  
    
  


  
  <span class="edit">



<a href="https://github.com/haacked/haacked.com/edit/gh-pages/_posts/2021/2021-02-12-argument-parsing-with-abbot.markdown">suggest edit</a>
</span>
</div>

  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Most Bot skills strive for a more natural language feel to arguments passed them. For example, to remember something with Abbot you can use <code class="language-plaintext highlighter-rouge">@abbot rem haacked's blog is https://haacked.com</code>. And then later recall it with <code class="language-plaintext highlighter-rouge">@abbot rem haacked's blog</code>. Or just <code class="language-plaintext highlighter-rouge">@abbot rem haacked</code> because Abbot uses fuzzy matching.</p>

<p>Abbot doesn’t strive for true natural language processing yet because many skills need precision in calling them and natural language interfaces can be stressful to use as you figure out the right way to call them. This may change in the future and it’s an area we hope to explore.</p>

<p>To achieve a more natural language feel, Bot skills tend to have a pretty simple format for the arguments passed to the skill. But even a simple format can require a fairly complex regular expression to parse correctly. And we all know what happens when you decide to <a href="http://regex.info/blog/2006-09-15/247">use a regular expression to solve a problem</a>. Spending a day writing regular expressions can make you feel like you’ve been slugged.</p>

<p><img src="https://user-images.githubusercontent.com/19977/107692389-92799080-6c61-11eb-9710-c75811b528ee.jpg" alt="Image of woman slugging a man - Simplified Pixabay License" title="The feeling I get when I parse arguments with a regular expression" /></p>

<p>Let’s follow an example to see what I mean. Suppose we have a skill for managing another user’s favorite songs with the following usage pattern.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@abbot fave {@mention} add {song} [description]
</code></pre></div></div>

<p>This skill allows the user to add a favorite song for another user with an optional description.</p>

<p>The regular expression to parse this seems relatively straightforward at first. Note that the arguments always omit the skill name so the arguments in this case would be the part after <code class="language-plaintext highlighter-rouge">fave</code>.</p>

<p>Here’s my regex so far: <code class="language-plaintext highlighter-rouge">^(?&lt;mention&gt;.*?)\s+(?&lt;cmd&gt;.*?)\s+(?&lt;song&gt;.*?)(\s+(?&lt;description&gt;.*))?$</code>.</p>

<p>The following set of chat transcripts show how the skill might be used.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@haack: @abbot fave @paul add Dynamite
@abbot: I've added `Dynamite` to @paul's list of favorite songs.
</code></pre></div></div>

<p>So far so good. Now it gets a bit trickier if we want to add a favorite song with a description.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@haack: @abbot fave @paul add Chandelier Because Sia speaks to me
@abbot: I've added `Chandelier` with the description `Because Sia speaks to me` to @paul's list of favorite songs
</code></pre></div></div>

<p>Which part is the song and which part is the description? Since descriptions tend to be sentences, it might make sense to have the first word after the command be the title, and the rest be the description. Until you run into the following example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@haack: @abbot fave @paul add Baby Shark Makes me dance
@abbot: I've added `Baby` with the description `Shark Makes me dance` to @paul's list of favorite songs
</code></pre></div></div>

<p>In this case, “Baby Shark” is the song. So what we need to do is allow quoting an argument.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@haack: @abbot fave @paul add "Baby Shark" Makes me dance
@abbot: I've added `Baby Shark` with the description `Makes me dance` to @paul's list of favorite songs.
</code></pre></div></div>

<p>Ah! That’s better.</p>

<p>To get this better behavior, we need to update the regular expression we’ve been using to something a bit more complicated: <code class="language-plaintext highlighter-rouge">^(?&lt;mention&gt;.*?)\s(?&lt;cmd&gt;.*?)\s(?:\"(?&lt;song&gt;.*?)\"|(?&lt;song&gt;.*?))(\s(?&lt;description&gt;.*))?$</code>. That’s not terrible, but as we handle more and more conditions, it gets more and more complicated.</p>

<p>Fortunately, Abbot handles this sort of argument parsing for you. If you write a C# skill, you have access to the arguments via the <code class="language-plaintext highlighter-rouge">Bot.Arguments</code> property. <code class="language-plaintext highlighter-rouge">Bot.Arguments</code> is a custom collection with some interesting properties to make argument handling easier. It contains a tokenized set of incoming arguments that already handles quoting and whitespace.</p>

<p>So in the case of the argument <code class="language-plaintext highlighter-rouge">@paul add "Baby Shark" Makes me dance</code> (the skill name is always omitted from the arguments), <code class="language-plaintext highlighter-rouge">Bot.Arguments</code> would contain the collection:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="m">0</span><span class="p">]:</span> <span class="n">@paul</span>
<span class="p">[</span><span class="m">1</span><span class="p">]:</span> <span class="k">add</span>
<span class="p">[</span><span class="m">2</span><span class="p">]:</span> <span class="n">Baby</span> <span class="n">Shark</span>
<span class="p">[</span><span class="m">3</span><span class="p">]:</span> <span class="n">Makes</span>
<span class="p">[</span><span class="m">4</span><span class="p">]:</span> <span class="n">me</span>
<span class="p">[</span><span class="m">5</span><span class="p">]:</span> <span class="n">dance</span>
</code></pre></div></div>

<p>“Now wait a minute,” you say. “Don’t we want the <em>description</em>, the <em>fourth</em> argument, to have the rest of the words after the song.” Right you are!</p>

<p>But in the <code class="language-plaintext highlighter-rouge">Bot.Arguments</code> collection, the fourth element in the collection is “Makes” and not the full description. This is a problem.</p>

<p>Not to worry, Abbot has a solution for this. <code class="language-plaintext highlighter-rouge">Bot.Arguments</code> implements <a href="https://docs.microsoft.com/en-us/dotnet/csharp/deconstruct">tuple deconstruction</a> in a special way. Suppose you know that you will have at most four arguments for a skill. You can deconstruct the arguments into a tuple like so.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="p">(</span><span class="n">cmdArg</span><span class="p">,</span> <span class="n">mentionArg</span><span class="p">,</span> <span class="n">songArg</span><span class="p">,</span> <span class="n">descriptionArg</span><span class="p">)</span> <span class="p">=</span> <span class="n">Bot</span><span class="p">.</span><span class="n">Arguments</span><span class="p">;</span>
</code></pre></div></div>

<p>If there are more than four arguments, the remaining arguments are captured in the last tuple parameter, in this case <code class="language-plaintext highlighter-rouge">descriptionArg</code>. If you’re familiar with JavaScript, this is a lot like <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/rest_parameters">rest parameters</a>.</p>

<p>Even though the remaining arguments are captured in <code class="language-plaintext highlighter-rouge">descriptionArg</code> (which is what we want in this case), you can still cast <code class="language-plaintext highlighter-rouge">descriptionArg</code> to <code class="language-plaintext highlighter-rouge">IArguments</code> to access each token that made up the description, if you needed to for some reason.</p>

<p>If there are less than four arguments, then the last argument will be of type <code class="language-plaintext highlighter-rouge">IMissingArgument</code>. So let’s put this all together.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="p">(</span><span class="n">cmdArg</span><span class="p">,</span> <span class="n">mentionArg</span><span class="p">,</span> <span class="n">songArg</span><span class="p">,</span> <span class="n">descriptionArg</span><span class="p">)</span> <span class="p">=</span> <span class="n">Bot</span><span class="p">.</span><span class="n">Arguments</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">cmdArg</span><span class="p">.</span><span class="n">Value</span> <span class="k">is</span> <span class="s">"add"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(!(</span><span class="n">mentionArg</span> <span class="k">is</span> <span class="n">IMentionArgument</span> <span class="n">mention</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">await</span> <span class="n">Bot</span><span class="p">.</span><span class="nf">ReplyAsync</span><span class="p">(</span><span class="s">"Please mention someone whose favorite song this is."</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">songArg</span> <span class="k">is</span> <span class="n">IMissingArgument</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="n">Bot</span><span class="p">.</span><span class="nf">ReplyAsync</span><span class="p">(</span><span class="s">"Please mention someone whose favorite song this is."</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Some magic here to save the favorite song...</span>
    <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">descriptionArg</span> <span class="k">is</span> <span class="n">IMissingArgument</span>
        <span class="p">?</span> <span class="s">$"I've added `</span><span class="p">{</span><span class="n">songArg</span><span class="p">.</span><span class="n">Value</span><span class="p">}</span><span class="s">` to </span><span class="p">{</span><span class="n">mention</span><span class="p">.</span><span class="n">Mentioned</span><span class="p">}</span><span class="s">'s list of favorite songs."</span>
        <span class="p">:</span> <span class="s">$"I've added `</span><span class="p">{</span><span class="n">songArg</span><span class="p">.</span><span class="n">Value</span><span class="p">}</span><span class="s">` with the description `</span><span class="p">{</span><span class="n">descriptionArg</span><span class="p">.</span><span class="n">Value</span><span class="p">}</span><span class="s">` to </span><span class="p">{</span><span class="n">mention</span><span class="p">.</span><span class="n">Mentioned</span><span class="p">}</span><span class="s">'s list of favorite songs."</span><span class="p">;</span>
    <span class="k">await</span> <span class="n">Bot</span><span class="p">.</span><span class="nf">ReplyAsync</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The rest of the code is left as an exercise for the reader.</p>

<p>A few things to note. At the moment, we only support deconstructing up to a four-tuple. We can easily add a five-tuple or six-tuple in the future. But in most cases, four is enough. And if it’s not, you can still deconstruct that fourth argument by casting it to <code class="language-plaintext highlighter-rouge">IArguments</code>.</p>

<p>There are helpful extension methods on <code class="language-plaintext highlighter-rouge">IArgument</code> (the base interface for all arguments). For example, <code class="language-plaintext highlighter-rouge">ToLocalTime</code> attempts to parse the argument as a local time (such as “2pm”) and return a <a href="https://nodatime.org/2.2.x/api/NodaTime.LocalTime.html"><code class="language-plaintext highlighter-rouge">LocalTime</code></a> if it succeeds. Otherwise it returns null. We’ll add more of these helpers as we go along. Let us know what else we should add by emailing <a href="mailto:feedback@aseriousbusiness.com">feedback@aseriousbusinees.com</a> or use the Abbot <code class="language-plaintext highlighter-rouge">feedback</code> skill.</p>

<p>If an argument is a mention, you can cast it to <code class="language-plaintext highlighter-rouge">IMentionArgument</code> to access information about the mentioned user. Mentions are also in the <code class="language-plaintext highlighter-rouge">Bot.Mentions</code> collection.</p>

<p>Also, if the default argument parsing doesn’t work for you, you can always access the full arguments with <code class="language-plaintext highlighter-rouge">Bot.Arguments.Value</code>. Python and JavaScript skills also receive the arguments as a collection in <code class="language-plaintext highlighter-rouge">bot.tokenized_arguments</code> and <code class="language-plaintext highlighter-rouge">bot.tokenizedArguments</code> respectively. They don’t have the same deconstructors that the C# code does, but mainly because those languages already have similar list operations.</p>

<p>If you’re interested in seeing the code for our argument parsing, check out <a href="https://gist.github.com/haacked/adbdc12fc6c8ea21d639deb3763fdd98">this gist</a>. It’s in a gist for now because I wanted a quick way to share it. We need to organize our code so it’s easier to share the parts we want to share as open source libraries. The parsing code is fairly simple right now, but we hope to expand it. It doesn’t support argument flags and such because the usage pattern for bot skills tend to be different than what you’d use with a command line tool. However, we may consider using an open source full-fledged command line parser in the future if there’s demand for it.</p>

<p>For more about writing skills for Abbot, check out the <a href="https://ab.bot/help/guides/">Getting Started Guides</a>.</p>

  </div>
  <span class="edit">Found a typo or mistake in the post? 



<a href="https://github.com/haacked/haacked.com/edit/gh-pages/_posts/2021/2021-02-12-argument-parsing-with-abbot.markdown">suggest edit</a>
</span>

  
    
  






<div id="comments" class="comments">
  <h2>Comments</h2>
  <form action="/fake" data-action="https://haacked-blog.azurewebsites.net/api/PostComment" method="post" class="comment-form form-horizontal comment-box">
    <input name="redirect" type="hidden" value="/thanks">
    <input name="post_id" type="hidden" value="argument-parsing-with-abbot">
    <input name="comment-site" type="hidden" value="">
    <div class="comment-box">
        <img src="/assets/img/unknown-avatar.png" data-fallbacksrc="/assets/img/unknown-avatar.png" data-role="user-avatar" alt="avatar" class="avatar" id="avatar-preview" />
        <div class="commenttext">
        <div class="comment-status status"></div>
        <div contenteditable="true" tabindex="0" role="textbox" aria-multiline="true" data-role="editable" class="textarea plaintext" aria-label="Join the discussion..." id="comment-div" data-target="message"></div>
        <input type="hidden" name="message" id="message" data-required="true" value="" />
        </div>
    </div>
    <div class="comment-author">
        <div class="control-group">
        <input type="hidden" name="avatar" id="avatar-input" />
        <input type="text" name="name" id="name" placeholder="Display Name" title="Name displayed with your comment" data-required="true" />
        <input type="text" name="identity" id="identity" placeholder="email/@twitter/github" data-required="true" value="" />
        <span class="info-circle" title="Identity is used to generate an avatar image only. It is cleared out when you click submit and not sent to the server."></span>
        <button type="button" class="comment-button">Leave response</button>
        <div class="remember-me">
            <input type="checkbox" name="remember" id="remember"><label for="remember">Remember me</label>
            <span class="info-circle" title="Stores your name and email in the browser so you don't have to fill out the form again. This does not set a cookie."></span>
        </div>
        </div>
    </div>
</form>

  <h3 class="comment-count">2 responses</h3>
  <ol class="comments-list">
  
  
    
    <li>
      <!-- URL for comment on GitHub
https://github.com/haacked/haacked.com/blob/gh-pages/_data/comments/argument-parsing-with-abbot/ababe399.yml
-->


<img alt="Avatar for Daniel Crowe" src="https://haacked.com/assets/img/unknown-avatar.png" class="avatar" height="48" width="48">


<blockquote id="ababe399">
  <cite>
    <span class="author">
      
        Daniel Crowe
      
    </span>
    <span class="bullet">•</span>
    <a href="#ababe399" class="muted" title="Fri, 12 Feb 2021 21:46:38 -0600">
      February
      
      13th,
      
      2021
    </a>
  </cite>
  <div class="comment-body"><p>I’d love to give it a go, but sadly slack signup seems to be having some trouble ATM. I keep getting a 404 at https://ab.bot/callback</p>
</div>
</blockquote>

    </li>
  
    
    <li>
      <!-- URL for comment on GitHub
https://github.com/haacked/haacked.com/blob/gh-pages/_data/comments/argument-parsing-with-abbot/2dc76bca.yml
-->


<img alt="Avatar for Haacked" src="https://github.com/haacked.png" class="avatar" height="48" width="48">


<blockquote id="2dc76bca">
  <cite>
    <span class="author">
      
        Haacked
      
    </span>
    <span class="bullet">•</span>
    <a href="#2dc76bca" class="muted" title="Fri, 12 Feb 2021 22:08:53 -0600">
      February
      
      13th,
      
      2021
    </a>
  </cite>
  <div class="comment-body"><p>Hey Daniel, I just deployed a fix for the problem you ran into. Please give it another try. Sorry about that!</p>
</div>
</blockquote>

    </li>
  
  </ol>
</div>


  

  <a class="u-url" href="/archive/2021/02/12/argument-parsing-with-abbot/" hidden></a>
</article>

      </div>
      <footer class="site-footer h-card">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            
              Phil Haack
            
            </li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
  
  
  
  <li><a href="https://github.com/haacked"><svg class="svg-icon"><use xlink:href="/assets/svg/minima-social-icons.svg#github"></use></svg> <span class="username">haacked</span></a></li>
  
  
  
  <li><a href="https://twitter.com/haacked"><svg class="svg-icon"><use xlink:href="/assets/svg/minima-social-icons.svg#twitter"></use></svg> <span class="username">haacked</span></a></li>
  
  
  <li><a href="http://feeds.haacked.com/haacked"><svg class="svg-icon"><use xlink:href="/assets/svg/minima-social-icons.svg#rss"></use></svg> <span>rss</span></a></li>
</ul>


<!--  viewBox="0 1 16 14" -->
      </div>

      <div class="footer-col footer-col-3">
        <p>You&#39;ve been Haacked is a blog about Technology, Software, Management, and Open Source. It&#39;s full of good stuff.
</p>
      </div>
    </div>

  </div>

</footer>

    </main>
  </body>
</html>
