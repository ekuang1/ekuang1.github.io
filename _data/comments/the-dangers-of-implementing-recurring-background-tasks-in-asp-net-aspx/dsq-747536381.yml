id: dsq-747536381
date: 2011-10-22T20:12:49.0000000-07:00
name: softlion
avatar: https://disqus.com/api/users/avatars/softlion.jpg
message: '<p>[code]<br>    public class WebTaskHost : IRegisteredObject<br>    {<br>        private readonly object _lock = new object();<br>        private bool isShuttingDown, isUnregistered;<br>        public WebTaskHost()<br>        {<br>            HostingEnvironment.RegisterObject(this);<br>        }<br>        public void Stop(bool immediate)<br>        {<br>            if (isShuttingDown)<br>                return;<br>            lock (_lock)<br>            {<br>                if (isShuttingDown)<br>                    return;<br>                isShuttingDown = true;<br>                if (immediate)<br>                {<br>                    HostingEnvironment.UnregisterObject(this);<br>                    isUnregistered = true;<br>                }<br>            }<br>        }<br>        /// &lt;summary&gt;<br>        /// <br>        /// &lt;/summary&gt;<br>        /// &lt;param name="action"&gt;&lt;/param&gt;<br>        /// &lt;returns&gt;false if the caller should shut down the work&lt;/returns&gt;<br>        public bool DoWork(Action action)<br>        {<br>            if (isShuttingDown &amp;&amp; isUnregistered)<br>                return false;<br>            lock (_lock)<br>            {<br>                if (isShuttingDown)<br>                {<br>                    if (!isUnregistered)<br>                    {<br>                        HostingEnvironment.UnregisterObject(this);<br>                        isUnregistered = true;<br>                    }<br>                    return false;<br>                }<br>                action();<br>            }<br>            return true;<br>        }<br>    }<br>[/code]<br></p>'
