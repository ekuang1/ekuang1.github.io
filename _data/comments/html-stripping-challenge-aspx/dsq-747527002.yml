id: dsq-747527002
date: 2008-11-15T10:52:32.0000000-08:00
name: Speednet
avatar: https://disqus.com/api/users/avatars/Speednet.jpg
message: "<p>@haacked:  I found another situation that requires another rule above, and I also have a minor quibble with one of your rules.<br>First, the quibble.  In your \"WithCommentInterleavedWithText\" test for removing comments, your test results show that if a comment is surrounded by a space on each side (as in that test), after the replacement only one of the spaces remains.<br>While it may appear that way on the page (two consecutive spaces appear as one space in the rendered page), in the DOM the two separate text nodes remain, one with a trailing space and the other with a leading space.  Thus, Html.StripHtml(\"Hello &lt;!--&gt; World\") should return \"Hello--World\" (dashes = spaces), not \"Hello-World\".<br>(As a caveat, Internet Explorer autmatically normalizes the node list after removing any nodes, in this case resulting in the two text nodes merging into one, with a single separating space, but standards-based browsers like Firefox correctly keep them as two separate text nodes.)<br>The additional exception I found is that script tags are handled in a special manner in browsers, so they must be dealt with differently than the regular tags and comments.<br>Through testing, I have found that once a script tag begins, it will never stop consuming text until it finds a &lt;/script&gt; tag.  So if there is an HTML comment embedded within the script tag, as happens with most script tags, then the comment inside the script tag will be incorrectly stripped by any HTML stripper that does not treat script tags as a special case.  (All the text after the first right-angle character (\"&gt;\") is found will be left in the string.)<br>Here is a test I concocted for script tags (I'm also displaying my VB bias):<br><code><br>&lt;TestMethod()&gt; _<br>Public Sub Html_ScriptWithEmbeddedRightAngle_ReturnsEmptyString()<br>    Dim s As String = \"&lt;script&gt;//&lt;![CDATA[\" &amp; vbCrLf &amp; \"alert('&gt;');//]]&gt;&lt;/script&gt;\"<br>    Assert.AreEqual(String.Empty, Html.StripHtml(s))<br>End Sub<br></code><br>So, as a result of the two items above, I have updated my original code so that it (a) does not attempt to consolidate spaces surrounding stripped comments, and (b) handles the special case of script tags.<br>(Incidentally, I found out one other interesting tidbit: It seems that the only HTML tag that cannot be closed by starting a new tag before the last right-angle character is the ending &lt;/script&gt; tag.  i.e., &lt;a href=\"#\"&gt;Hello&lt;/a&lt;br /&gt; does display a link, but &lt;/script&lt;br /&gt; will not end a script.)<br><code><br>Public Class Html<br>    Private Shared ReadOnly _Regex_HTML As New Regex(\"&lt;script(?=[\\s&lt;&gt;])(?&gt;[^&lt;]|&lt;(?!/script[\\s&gt;]))*&lt;/script(?&gt;=\\s*\"\"[^\"\"]*\"\"|=\\s*'[^']*'|[^&lt;&gt;])*(?(?=&lt;)|&gt;)|&lt;/?(?=[a-z])(?&gt;[=]\\s*\"\"[^\"\"]*\"\"|=\\s*'[^']*'|[^&lt;&gt;])+(?(?=&lt;)|&gt;)|&lt;![^&gt;]*&gt;\", RegexOptions.Compiled Or RegexOptions.IgnoreCase)<br>    Public Shared Function StripHtml(ByVal html As String) As String<br>        Return _Regex_HTML.Replace(html, \"\")<br>    End Function<br>End Class<br></code><br>-Todd<br></p>"
