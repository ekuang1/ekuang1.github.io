id: 6b495a64
date: 2020-09-29T21:58:23.2020287Z
name: Erik A. Brandstadmoen
avatar: https://github.com/@erikbra.png
message: "We use client certificates, and would like to skip that for the site warmup and ping from alwaysOn. After a lot of trial and error, we've actually had to use all of this to allow for both site warmups, the always on request, etc. Look at the list of user-agents. And it might also use an http header. It's a bit messy. But this is all the variants we've had to allow to make it work. It has taken some time to find them all :)\r\n\r\n```\r\n   private bool ShouldSkipCertificateValidation(HttpContext context)\r\n        {\r\n            return UserAgentIsRecognized(context) &&\r\n                   (IsFromLocalHostAddress(context) ||\r\n                   (IsFromInternalAddress(context) && HasWellKnownMicrosoftAuthHeader(context)));\r\n        }\r\n\r\n        private static bool HasWellKnownMicrosoftAuthHeader(HttpContext context) =>\r\n            context.Request.Headers[\"x-ms-auth-allow-http\"].Equals(\"true\");\r\n\r\n        private static bool IsFromInternalAddress(HttpContext context) =>\r\n            GetClientIpAddress(context).GetAddressBytes().First() == 10;\r\n\r\n        private static bool IsFromLocalHostAddress(HttpContext context) =>\r\n            IPAddress.IsLoopback(GetClientIpAddress(context));\r\n        \r\n\r\n        private bool UserAgentIsRecognized(HttpContext context) => GetUserAgent(context).In(RecognizedUserAgents);\r\n        \r\n        private static IEnumerable<string> RecognizedUserAgents => new[]\r\n        {\r\n            \"AlwaysOn\",\r\n            \"HostnameSyncPinger\",\r\n            \"SiteWarmup\",\r\n            \"IIS Application Initialization Warmup\",\r\n            \"IIS Application Initialization Preload\"\r\n        };\r\n\r\n\r\n        private static IPAddress GetClientIpAddress(HttpContext context) => context.Connection.RemoteIpAddress;\r\n        private static string GetUserAgent(HttpContext context) => context.Request.Headers[\"User-Agent\"];\r\n```"
