id: dsq-747527703
date: 2009-01-11T20:42:47.0000000-08:00
name: Richard
avatar: https://disqus.com/api/users/avatars/Richard.jpg
message: "<p>@JDConley: The Disposed method of your SynchronizationContextSwitcher class should be checking to make sure that it's running on the same thread as the constructor, and that the current context hasn't been changed since the constructor was called.<br>private ExecutionContext _executionContext;<br>private readonly SynchronizationContext _oldContext;<br>private readonly SynchronizationContext _newContext;<br>public SynchronizationContextSwitcher(SynchronizationContext context)<br>{<br>    _newContext = context;<br>    _executionContext = Thread.CurrentThread.ExecutionContext;<br>    _oldContext = SynchronizationContext.Current;<br>    SynchronizationContext.SetSynchronizationContext(context);<br>}<br>public void Dispose()<br>{<br>    if (null != _executionContext)<br>    {<br>        if (_executionContext != Thread.CurrentThread.ExecutionContext)<br>        {<br>            throw new InvalidOperationException(\"Dispose called on wrong thread.\");<br>        }<br>        if (_newContext != SynchronizationContext.Current)<br>        {<br>            throw new InvalidOperationException(\"The SynchronizationContext has changed.\");<br>        }<br>        <br>        SynchronizationContext.SetSynchronizationContext(_oldContext);<br>        _executionContext = null;<br>    }<br>}</p>"
